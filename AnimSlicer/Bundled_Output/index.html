<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimSlicer - Single File Preview</title>
    <script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/" } }
    </script>
    <style> body { margin: 0; overflow: hidden; background: #1e1e1e; font-family: sans-serif; color: white; } #canvas-container { width: 100vw; height: 100vh; } #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; } button { padding: 8px 16px; background: #4a9eff; border: none; border-radius: 4px; color: white; cursor: pointer; } button:hover { background: #6ab0ff; } #info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 4px; pointer-events: none; } </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="info">Current: None</div>
    <div id="controls"></div>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const config = {
	"clips": [
		{
			"end": 0.611887666554497,
			"loop": false,
			"name": "Attack1_1",
			"sourceAnim": "Attack1",
			"speed": 1.0,
			"start": 0.0
		},
		{
			"end": 1.20833337306976,
			"loop": false,
			"name": "Attack1_2",
			"sourceAnim": "Attack1",
			"speed": 1.0,
			"start": 0.611887666554497
		},
		{
			"end": 1.34584664536741,
			"loop": true,
			"name": "Emote2_1",
			"sourceAnim": "Emote2",
			"speed": 1.0,
			"start": 0.0
		},
		{
			"end": 2.5,
			"loop": true,
			"name": "Emote2_2",
			"sourceAnim": "Emote2",
			"speed": 1.0,
			"start": 1.34584664536741
		},
		{
			"end": 0.5,
			"loop": true,
			"name": "Run-loop_1",
			"sourceAnim": "Run-loop",
			"speed": 1.0,
			"start": 0.0
		},
		{
			"end": 0.5,
			"loop": true,
			"name": "Run-loop_2",
			"sourceAnim": "Run-loop",
			"speed": 2.0,
			"start": 0.0
		},
		{
			"end": 0.5,
			"loop": true,
			"name": "Run-loop_3",
			"sourceAnim": "Run-loop",
			"speed": 0.1,
			"start": 0.0
		}
	],
	"modelFile": "3DGodotRobot.glb",
	"sourceAnimationName": "Attack1"
};

        let mixer, actions = {}, currentAction = null;
        const clock = new THREE.Clock();

        async function init() {
            if (window.location.protocol === 'file:') { alert("⚠️ CORS Error: Please use a Local Server."); }
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e1e1e);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement);
            scene.add(new THREE.DirectionalLight(0xffffff, 1));
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));

            const loader = new GLTFLoader();
            loader.load(config.modelFile, (gltf) => {
                scene.add(gltf.scene);
                if (gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(gltf.scene);
                    
                    // --- 核心邏輯 (與 main.js 一致) ---
                    let globalDefaultAnim = gltf.animations[0];
                    if (config.sourceAnimationName) {
                        const found = gltf.animations.find(a => a.name === config.sourceAnimationName);
                        if (found) globalDefaultAnim = found;
                    }

                    config.clips.forEach(clip => {
                        let targetAnim = globalDefaultAnim;
                        // [關鍵修正]
                        if (clip.sourceAnim && clip.sourceAnim !== "") {
                             const exactMatch = gltf.animations.find(a => a.name === clip.sourceAnim);
                             if (exactMatch) targetAnim = exactMatch;
                        } else if (!config.sourceAnimationName) {
                            const exactMatch = gltf.animations.find(a => a.name === clip.name);
                            if (exactMatch) targetAnim = exactMatch;
                        }
                    
                        const sub = THREE.AnimationUtils.subclip(targetAnim, clip.name, clip.start * 30, clip.end * 30);
                        const action = mixer.clipAction(sub);
                        if (!clip.loop) { action.setLoop(THREE.LoopOnce); action.clampWhenFinished = true; }
                        action.timeScale = clip.speed;
                        actions[clip.name] = action;

                        const btn = document.createElement('button');
                        btn.textContent = clip.name;
                        btn.onclick = () => {
                            if (currentAction) currentAction.fadeOut(0.2);
                            currentAction = actions[clip.name];
                            currentAction.reset().fadeIn(0.2).play();
                            document.getElementById('info').textContent = 'Current: ' + clip.name;
                        };
                        document.getElementById('controls').appendChild(btn);
                    });
                }
            });
            function animate() {
                requestAnimationFrame(animate);
                if (mixer) mixer.update(clock.getDelta());
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            window.onresize = () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            };
        }
        init();
    </script>
</body>
</html>
